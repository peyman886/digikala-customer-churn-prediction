# =============================================================================
# Docker Compose - Digikala Customer Churn Prediction (GPU Version)
# =============================================================================
#
# Services:
#   - db:       PostgreSQL 16 database
#   - api:      FastAPI backend with GPU support (port 9000)
#   - frontend: Streamlit dashboard (port 8501)
#   - mlflow:   MLflow tracking server (port 5000)
#   - jupyter:  JupyterLab with GPU (port 8888) [dev profile]
#   - pgadmin:  Database admin UI (port 5050) [dev profile]
#
# Usage:
#   Production:    docker-compose up -d
#   Development:   docker-compose --profile dev up -d
#   CPU only:      docker-compose -f docker-compose.yml -f docker-compose.cpu.yml up -d
#
# Prerequisites:
#   - NVIDIA GPU with CUDA support
#   - nvidia-docker2 installed
#   - Docker Compose v2+
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  db:
    image: postgres:16-alpine
    container_name: churn_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-ds_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-ds_pass}
      POSTGRES_DB: ${DB_NAME:-churn_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro
    ports:
      - "${DB_PORT:-5432}:5432"
    networks:
      - churn_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ds_user} -d ${DB_NAME:-churn_db}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ---------------------------------------------------------------------------
  # FastAPI Backend (GPU)
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: churn_api
    restart: unless-stopped
    environment:
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-churn_db}
      - DB_USER=${DB_USER:-ds_user}
      - DB_PASSWORD=${DB_PASSWORD:-ds_pass}
      - DATABASE_URL=postgresql://${DB_USER:-ds_user}:${DB_PASSWORD:-ds_pass}@db:5432/${DB_NAME:-churn_db}
      - MODEL_DIR=/app/models_v2
      - FEATURES_PATH=/app/user_features.csv
      - DEVICE=auto
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./models_v2:/app/models_v2:ro
      - ./user_features.csv:/app/user_features.csv:ro
    ports:
      - "${API_PORT:-9000}:9000"
    networks:
      - churn_network
    depends_on:
      db:
        condition: service_healthy
    # GPU support - requires nvidia-docker2
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Streamlit Frontend
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: churn_frontend
    restart: unless-stopped
    environment:
      - API_URL=http://api:9000
    ports:
      - "${FRONTEND_PORT:-8501}:8501"
    networks:
      - churn_network
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ---------------------------------------------------------------------------
  # MLflow Tracking Server
  # ---------------------------------------------------------------------------
  mlflow:
    image: python:3.11-slim
    container_name: churn_mlflow
    restart: unless-stopped
    working_dir: /mlflow
    command: >
      bash -c "
        pip install --quiet mlflow==2.19.0 &&
        mlflow server 
          --host 0.0.0.0 
          --port 5000 
          --backend-store-uri sqlite:///mlflow.db
          --default-artifact-root /mlflow/artifacts
      "
    volumes:
      - ./mlruns:/mlflow/artifacts
      - mlflow_data:/mlflow
    ports:
      - "${MLFLOW_PORT:-5000}:5000"
    networks:
      - churn_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ---------------------------------------------------------------------------
  # JupyterLab (Development Only - GPU)
  # ---------------------------------------------------------------------------
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile.jupyter
    container_name: churn_jupyter
    restart: unless-stopped
    environment:
      - JUPYTER_TOKEN=${JUPYTER_TOKEN:-churn123}
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-churn_db}
      - DB_USER=${DB_USER:-ds_user}
      - DB_PASSWORD=${DB_PASSWORD:-ds_pass}
      - DATABASE_URL=postgresql://${DB_USER:-ds_user}:${DB_PASSWORD:-ds_pass}@db:5432/${DB_NAME:-churn_db}
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    volumes:
      - ./notebooks:/home/jovyan/work/notebooks
      - ./data:/home/jovyan/work/data
      - ./src:/home/jovyan/work/src
      - ./app:/home/jovyan/work/app
      - ./db:/home/jovyan/work/db
      - ./mlops:/home/jovyan/work/mlops
      - ./mlruns:/home/jovyan/work/mlruns
      - ./models_v2:/home/jovyan/work/models_v2
      - ./reports:/home/jovyan/work/reports
    ports:
      - "${JUPYTER_PORT:-8888}:8888"
    networks:
      - churn_network
    depends_on:
      db:
        condition: service_healthy
    # GPU support
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    profiles:
      - dev

  # ---------------------------------------------------------------------------
  # PgAdmin (Development Only)
  # ---------------------------------------------------------------------------
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: churn_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@local.dev}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    networks:
      - churn_network
    depends_on:
      - db
    profiles:
      - dev

# =============================================================================
# Networks
# =============================================================================
networks:
  churn_network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  mlflow_data:
    driver: local
